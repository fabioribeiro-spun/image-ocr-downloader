<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Coletor de Criativos (Google Ads Transparency)</title>
  <style>
    body{font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:0;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:860px;margin:40px auto;padding:0 20px}
    h1{color:#93c5fd;margin:0 0 10px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:18px;margin-top:16px}
    a.bm{display:inline-block;background:#2563eb;color:#fff;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:700}
    code{background:#0b1220;border:1px solid #1f2937;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Coletor de Criativos (OCR inglÃªs)</h1>
    <div class="card">
      <p>Se vocÃª estÃ¡ vendo esta pÃ¡gina, o app estÃ¡ <b>ok</b> âœ….</p>
      <p>Arraste o botÃ£o para a barra de favoritos e use-o dentro do Ads Transparency.</p>
      <p><a id="bm" class="bm" href="#">ðŸ”– Arraste para os favoritos</a></p>
      <p>Ou abra a pÃ¡gina de processamento direto: <a href="/ocr.html">/ocr.html</a></p>
    </div>
  </div>

  <script>
    (function(){
      const BASE   = location.origin;
      const TARGET = BASE + "/ocr.html";

      // Bookmarklet corrigido (coleta em shadow DOM e iframes same-origin)
      const js = `
      (()=>{const BASE='${BASE}',TARGET='${TARGET}';
        const sleep=ms=>new Promise(r=>setTimeout(r,ms));
        const getBgUrls=el=>{try{const s=getComputedStyle(el).backgroundImage;
          return[...s.matchAll(/url\\((?:'|")?(.*?)(?:'|")?\\)/g)].map(m=>m[1])}catch{return[]}};
        const collectFromRoot=root=>{
          const urls=new Set();
          const pick=u=>{ if(u && /^https?:\\/\\//.test(u) && !/\\.svg(\\?|$)/i.test(u) && !u.startsWith('data:')) urls.add(u) };
          root.querySelectorAll('img').forEach(img=>{
            let u=img.currentSrc||img.src;
            const ss=img.getAttribute('srcset');
            if(ss){ try{
              const parts=ss.split(',').map(x=>x.trim().split(' '));
              parts.sort((a,b)=>parseInt((b[1]||'0').replace(/\\D/g,'')) - parseInt((a[1]||'0').replace(/\\D/g,'')));
              if(parts[0] && parts[0][0]) u=parts[0][0];
            }catch{} }
            pick(u);
          });
          root.querySelectorAll('*').forEach(el=> getBgUrls(el).forEach(pick));
          root.querySelectorAll('*').forEach(el=>{ if(el.shadowRoot){ for(const u of collectFromRoot(el.shadowRoot)) urls.add(u); }});
          return urls;
        };
        const uniq=new Set();
        (async()=>{
          for(let i=0;i<10;i++){ window.scrollBy(0, innerHeight*1.25); await sleep(800); }
          for(const u of collectFromRoot(document)) uniq.add(u);
          document.querySelectorAll('iframe').forEach(iframe=>{
            try{ const doc=iframe.contentDocument; if(doc){ for(const u of collectFromRoot(doc)) uniq.add(u); } }catch{}
          });
          const urls=[...uniq].slice(0,150);
          if(!urls.length){ alert('Nada coletado. Role mais e clique no favorito novamente.'); return; }
          const w=window.open(TARGET,'_blank');
          const t=setInterval(()=>{ try{ w.postMessage({type:'ads-urls',urls}, BASE); clearInterval(t); }catch{} }, 500);
        })();
      })();`.trim();

      const a = document.getElementById("bm");
      a.href = "javascript:" + encodeURIComponent(js).replace(/%20/g," ");
    })();
  </script>
</body>
</html>
