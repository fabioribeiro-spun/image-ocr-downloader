<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Coletor de An√∫ncios (Google Ads Transparency)</title>
  <style>
    body{font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:0;background:#0f172a;color:#e2e8f0}
    .wrap{max-width:880px;margin:40px auto;padding:0 20px}
    h1{font-size:28px;margin:0 0 12px;color:#93c5fd}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:20px;margin-top:16px}
    code,kbd{background:#0b1220;border:1px solid #1f2937;padding:2px 6px;border-radius:6px}
    a.bm{display:inline-block;margin-top:10px;background:#2563eb;color:#fff;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:700}
    .muted{color:#9ca3af}
    ol{margin-left:20px}
    .ok{color:#86efac}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Coletor (OCR ingl√™s) para Google Ads Transparency</h1>

    <div class="card">
      <p>Este bookmarklet roda <strong>OCR (eng)</strong> no seu navegador, aprova s√≥ criativos com <em>texto em ingl√™s</em> e manda baixar um ZIP via este servidor.</p>
      <p class="muted">Use em p√°ginas como:<br>
        <code>https://adstransparency.google.com/advertiser/AR...?... </code>
      </p>
      <p><a id="bm" class="bm" href="#">üîñ Arraste este bot√£o para a sua barra de favoritos</a></p>
      <p class="muted">Depois, abra a p√°gina do anunciante e clique no favorito.</p>
    </div>

    <div class="card">
      <h3>Como funciona</h3>
      <ol>
        <li>Rola a p√°gina para carregar mais criativos.</li>
        <li>Coleta URLs de imagens (inclui <code>&lt;img&gt;</code>, <code>srcset</code> e <code>background-image</code>).</li>
        <li>Roda OCR com <code>eng</code> na imagem via <code>/api/proxy-image</code>.</li>
        <li>Aprova s√≥ se for ingl√™s (ASCII) e confian√ßa ‚â• <code>60%</code> (ajust√°vel).</li>
        <li>Envia aprovadas para <code>/api/download-zip</code> e baixa.</li>
      </ol>
      <p class="ok">Tudo isso sem Puppeteer no servidor ü§ù</p>
    </div>
  </div>

  <script>
    // Gera o bookmarklet dinamicamente com o BASE = mesmo host do app
    (function(){
      const BASE = window.location.origin;
      const API_ZIP = BASE + "/api/download-zip";
      const PROXY_FN = "const PROXY=u=>'" + BASE + "/api/proxy-image?url=' + encodeURIComponent(u);";

      // === Bookmarklet (mesma l√≥gica que combinamos) ===
      const blob = `
      (async()=>{
        const API_ZIP='${API_ZIP}';
        ${PROXY_FN}
        const sleep=ms=>new Promise(r=>setTimeout(r,ms));
        const minConf=60,scrollTimes=10,scrollDelay=900,maxImgs=150,minW=120,minH=120;

        function loadTess(){
          return new Promise((res,rej)=>{
            if(window.Tesseract){res();return}
            const s=document.createElement('script');
            s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5.1.1/dist/tesseract.min.js';
            s.onload=res; s.onerror=()=>rej(new Error('Falha ao carregar Tesseract.js'));
            document.head.appendChild(s);
          });
        }

        const getBg=(el)=>{try{
          const bg=getComputedStyle(el).backgroundImage;
          return[...bg.matchAll(/url\\((?:'|")?(.*?)(?:'|")?\\)/g)].map(m=>m[1])
        }catch{return[]}}
        const uniq=new Set();
        for(let i=0;i<scrollTimes;i++){window.scrollBy(0,window.innerHeight*1.25);await sleep(scrollDelay)}
        ;[...document.images].forEach(img=>{
          if((img.naturalWidth||img.width)>=minW&&(img.naturalHeight||img.height)>=minH){
            const u=img.currentSrc||img.src; if(u) uniq.add(u);
          }
        });
        document.querySelectorAll('source[srcset]').forEach(s=>{
          const first=(s.getAttribute('srcset')||'').split(',')[0].trim().split(' ')[0];
          if(first) uniq.add(first);
        });
        document.querySelectorAll('*').forEach(el=>getBg(el).forEach(u=>uniq.add(u)));

        let urls=[...uniq].filter(u=>/^https?:\\/\\//.test(u)&&!/\\.svg($|\\?)/i.test(u)&&!u.startsWith('data:')).slice(0,maxImgs);
        if(!urls.length){alert('Nenhuma imagem encontrada. Role mais e tente de novo.');return}

        await loadTess();
        const approved=[];
        const isAscii=(t)=>/[A-Za-z]/.test(t)&&!/[√Ä-√ñ√ò-√∂√∏-√ø]/.test(t);

        const bar=document.createElement('div');
        Object.assign(bar.style,{position:'fixed',top:'10px',left:'50%',transform:'translateX(-50%)',padding:'8px 12px',background:'#111',color:'#fff',font:'600 13px system-ui',borderRadius:'8px',zIndex:999999});
        document.body.appendChild(bar);
        let done=0;

        for(const raw of urls){
          bar.textContent=\`OCR (eng) \${++done}/\${urls.length}\`;
          try{
            const prox=PROXY(raw);
            const img=await new Promise((res,rej)=>{
              const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.crossOrigin='anonymous'; im.src=prox;
            });
            const cv=document.createElement('canvas');
            cv.width=img.naturalWidth; cv.height=img.naturalHeight;
            const ctx=cv.getContext('2d'); ctx.drawImage(img,0,0);
            const r=await Tesseract.recognize(cv,'eng');
            const words=r.data.words||[];
            const conf=words.length?words.reduce((s,w)=>s+(w.confidence||0),0)/words.length:(r.data.confidence||0);
            const text=(r.data.text||'').trim();
            if(isAscii(text)&&conf>=minConf){approved.push(raw)}
          }catch(e){}
          await sleep(60);
        }
        document.body.removeChild(bar);

        if(!approved.length){alert('Nenhuma imagem com texto em ingl√™s ‚â• '+minConf+'%.');return}
        if(!confirm(\`Aprovadas \${approved.length} de \${urls.length}. Gerar ZIP?\`)) return;

        try{
          const resp=await fetch(API_ZIP,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({urls:approved})});
          if(!resp.ok) throw new Error('Falha no servidor');
          const blob=await resp.blob();
          const a=document.createElement('a');
          a.href=URL.createObjectURL(blob); a.download='ads-english.zip'; a.click();
          setTimeout(()=>URL.revokeObjectURL(a.href),1500);
        }catch(e){console.error(e); alert('Erro ao gerar ZIP')}
      })();`.trim();

      const href = "javascript:" + encodeURIComponent(blob)
        // Safari/Firefox aceitam sem encode; mas encodeURIComponent deixa seguro para drag&drop.
        .replace(/%20/g, " ");

      const a = document.getElementById("bm");
      a.href = href;
    })();
  </script>
</body>
</html>
