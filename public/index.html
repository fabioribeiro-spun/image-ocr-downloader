<script>
  // Gera o bookmarklet com BASE = mesmo host do app
  (function(){
    const BASE   = location.origin;
    const TARGET = BASE + "/ocr.html";

    // ---- Bookmarklet (minificado) ----
    const js = `
    (()=>{const BASE='${BASE}',TARGET='${TARGET}';
      const sleep=ms=>new Promise(r=>setTimeout(r,ms));
      const getBgUrls=el=>{try{const s=getComputedStyle(el).backgroundImage;
        return[...s.matchAll(/url\\((?:'|")?(.*?)(?:'|")?\\)/g)].map(m=>m[1])}catch{return[]}};
      // entra em shadowRoots e iframes same-origin
      const collectFromRoot=root=>{
        const urls=new Set();
        const pick=(u)=>{ if(u && /^https?:\\/\\//.test(u) && !/\\.svg(\\?|$)/i.test(u) && !u.startsWith('data:')) urls.add(u) };
        // imgs
        root.querySelectorAll('img').forEach(img=>{
          // pega a maior do srcset se houver
          let u=img.currentSrc||img.src;
          const ss=img.getAttribute('srcset');
          if(ss){ try{
            const parts=ss.split(',').map(x=>x.trim().split(' '));
            parts.sort((a,b)=>parseInt((b[1]||'0').replace(/\\D/g,'')) - parseInt((a[1]||'0').replace(/\\D/g,'')));
            if(parts[0] && parts[0][0]) u=parts[0][0];
          }catch{} }
          pick(u);
        });
        // backgrounds
        root.querySelectorAll('*').forEach(el=> getBgUrls(el).forEach(pick));
        // shadow roots
        root.querySelectorAll('*').forEach(el=>{ if(el.shadowRoot){ for(const u of collectFromRoot(el.shadowRoot)) urls.add(u); }});
        return urls;
      };

      const uniq=new Set();
      (async()=>{
        // rola para disparar lazy-loading
        for(let i=0;i<10;i++){ window.scrollBy(0, innerHeight*1.25); await sleep(800); }

        // 1) coleta no documento principal
        for(const u of collectFromRoot(document)) uniq.add(u);

        // 2) tenta entrar em iframes same-origin (alguns blocos do app estÃ£o neles)
        document.querySelectorAll('iframe').forEach(iframe=>{
          try{
            const doc=iframe.contentDocument;
            if(doc){ for(const u of collectFromRoot(doc)) uniq.add(u); }
          }catch{} // cross-origin -> ignorar
        });

        const urls=[...uniq].slice(0,150);
        if(!urls.length){ alert('Nada coletado. Role mais e clique no favorito novamente.'); return; }

        // abre o processador (ocr.html) e envia via postMessage
        const w=window.open(TARGET,'_blank');
        const send=()=>{ try{ w.postMessage({type:'ads-urls',urls}, BASE); }catch{} };
        const t=setInterval(()=>{ send(); clearInterval(t); }, 500);
      })();
    })();`.trim();

    const a = document.getElementById("bm");
    a.href = "javascript:" + encodeURIComponent(js).replace(/%20/g," ");
  })();
</script>
