<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ferramenta de Download de Imagens (com OCR)</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.1/dist/tesseract.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);color:#333;min-height:100vh;padding:20px;display:flex;flex-direction:column;align-items:center}
    .container{width:100%;max-width:1200px;background:rgba(255,255,255,.95);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:30px;margin-top:20px}
    header{text-align:center;margin-bottom:20px}
    h1{color:#2575fc;margin-bottom:8px;font-size:2.2rem}
    .subtitle{color:#6a11cb;font-size:1rem;margin-bottom:10px}
    .input-section{display:grid;grid-template-columns:1fr auto;gap:12px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:12px;margin-bottom:10px}
    input[type="url"],input[type="number"]{padding:12px;border:2px solid #ddd;border-radius:8px;font-size:15px;transition:border-color .3s}
    input[type="url"]:focus,input[type="number"]:focus{border-color:#2575fc;outline:none}
    label{font-size:13px;color:#444;margin-bottom:4px}
    .ctrl{display:flex;flex-direction:column}
    button{background:#2575fc;color:#fff;border:none;padding:12px 18px;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;transition:background .3s,transform .2s;height:44px}
    button:hover{background:#6a11cb;transform:translateY(-1px)}
    .options{display:flex;gap:16px;align-items:center;margin:8px 0 0}
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;margin-top:18px}
    .image-card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.1);transition:transform .3s}
    .image-card:hover{transform:translateY(-4px)}
    .image-container{height:180px;overflow:hidden;background:#f4f6f8}
    .image-container img{width:100%;height:100%;object-fit:cover;transition:transform .5s}
    .image-card:hover .image-container img{transform:scale(1.03)}
    .image-info{padding:14px}
    .image-info h3{margin-bottom:8px;color:#2575fc;font-size:16px}
    .image-info p{color:#555;font-size:13px;margin-bottom:10px;line-height:1.4}
    .meta{font-size:12px;color:#777;margin-bottom:10px}
    .actions{display:flex;gap:8px}
    .btn{background:#6a11cb;color:#fff;text-align:center;padding:10px;border-radius:6px;cursor:pointer;font-weight:600;flex:1}
    .btn:hover{background:#2575fc}
    .loading{text-align:center;padding:28px;font-size:16px;color:#2575fc}
    .notification{position:fixed;top:20px;right:20px;padding:14px 20px;border-radius:8px;background:#4CAF50;color:#fff;box-shadow:0 5px 15px rgba(0,0,0,.2);transform:translateX(120%);transition:transform .3s;z-index:1000}
    .notification.show{transform:translateX(0)}
    .progress{height:8px;background:#e9eef5;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#6a11cb,#2575fc)}
    footer{margin-top:30px;text-align:center;color:#fff;font-size:14px}
    small.note{color:#5b6b82;font-size:12px}
    @media (max-width:900px){.row{grid-template-columns:repeat(2,minmax(120px,1fr))}}
    @media (max-width:600px){.input-section{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Ferramenta de Download de Imagens</h1>
    <p class="subtitle">Encontre imagens com <strong>texto em inglês</strong> e baixe em 1 clique (OCR no navegador)</p>
  </header>

  <div class="container">
    <div class="input-section">
      <div class="ctrl" style="grid-column:1/2;">
        <label for="siteUrl">URL do site (ex.: https://exemplo.com)</label>
        <input type="url" id="siteUrl" placeholder="https://exemplo.com" value="">
      </div>
      <button id="searchBtn" aria-label="Buscar imagens">Buscar Imagens</button>
    </div>

    <div class="row">
      <div class="ctrl">
        <label for="limit">Limite de imagens analisadas</label>
        <input type="number" id="limit" min="1" max="200" value="40">
      </div>
      <div class="ctrl">
        <label for="minConfidence">Confiança mínima do OCR (0–100)</label>
        <input type="number" id="minConfidence" min="0" max="100" value="60">
      </div>
      <div class="ctrl">
        <label for="lang">Idioma do OCR</label>
        <input type="text" id="lang" value="eng" />
        <small class="note">padrão: inglês (eng)</small>
      </div>
    </div>

    <div id="status" class="loading">Digite uma URL e clique em “Buscar Imagens”.</div>
    <div id="progressWrap" style="display:none;">
      <div class="progress"><div id="progressBar" class="bar"></div></div>
      <small id="progressText" class="note"></small>
    </div>

    <div id="resultsContainer" class="results"></div>
  </div>

  <div id="notification" class="notification" role="alert" aria-live="polite">Pronto!</div>
  <footer><p>&copy; 2025</p></footer>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const toast = (msg, ok=true) => {
      const el = document.querySelector('#notification');
      el.textContent = msg;
      el.style.background = ok ? '#4CAF50' : '#E53935';
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2600);
    };
    const setProgress = (pct, txt='') => {
      const bar = $('#progressBar'); const wrap = $('#progressWrap'); const lab = $('#progressText');
      wrap.style.display = 'block'; bar.style.width = pct + '%'; lab.textContent = txt;
      if (pct >= 100) setTimeout(()=> wrap.style.display='none', 600);
    };

    async function fetchImagesFromServer(url, limit){
      const resp = await fetch(`/api/fetch-images?url=${encodeURIComponent(url)}&limit=${Number(limit)||40}`);
      if(!resp.ok) throw new Error('Falha ao buscar imagens.');
      return resp.json();
    }

    function renderCards(items){
      const cont = $('#resultsContainer');
      cont.innerHTML = '';
      if(!items.length){ $('#status').innerHTML = '<div class="loading">Nenhuma imagem encontrada.</div>'; return; }
      $('#status').innerHTML = '';
      items.forEach((u,i)=>{
        const card = document.createElement('div');
        card.className = 'image-card';
        card.innerHTML = `
          <div class="image-container"><img src="/api/proxy-image?url=${encodeURIComponent(u)}" alt="image"/></div>
          <div class="image-info">
            <h3>Imagem ${i+1}</h3>
            <p>Pré-visualização via proxy (CORS-free).</p>
            <div class="meta">Fonte: ${'${'}new URL(u).hostname}</div>
            <div class="actions">
              <div class="btn" data-url="${'${'}u}" data-name="img-${'${'}i}.jpg">Download</div>
              <div class="btn" data-open="${'${'}u}">Abrir origem</div>
            </div>
          </div>`;
        cont.appendChild(card);
      });

      $$('#resultsContainer .btn').forEach(b=>{
        const u = b.getAttribute('data-url');
        const name = b.getAttribute('data-name');
        const o = b.getAttribute('data-open');
        b.addEventListener('click', ()=>{
          if (u) downloadViaProxy(u, name); else window.open(o, '_blank');
        });
      });
    }

    async function downloadViaProxy(url, filename){
      try{
        const res = await fetch(`/api/proxy-image?url=${encodeURIComponent(url)}`);
        if(!res.ok) throw new Error('proxy falhou');
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename || 'image.jpg';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1400);
        toast('Download iniciado');
      }catch(e){ toast('Não foi possível baixar.', false); }
    }

    async function ocrImgElement(imgEl, lang='eng'){
      const canvas = document.createElement('canvas');
      canvas.width = imgEl.naturalWidth; canvas.height = imgEl.naturalHeight;
      const ctx = canvas.getContext('2d'); ctx.drawImage(imgEl,0,0);
      const r = await Tesseract.recognize(canvas, lang);
      const words = r.data.words || [];
      const conf = words.length ? (words.reduce((s,w)=> s + (w.confidence||0), 0) / words.length) : (r.data.confidence || 0);
      return { text: (r.data.text || '').trim(), confidence: conf };
    }

    async function analyzeWithOCR(minConfidence, lang){
      const cards = $$('#resultsContainer .image-card');
      let passed = 0;
      for (let i=0;i<cards.length;i++){
        const img = cards[i].querySelector("img");
        setProgress(Math.min(95, Math.round(((i+1)/cards.length)*90)+5), `OCR ${i+1}/${cards.length}`);
        try{
          const { text, confidence } = await ocrImgElement(img, lang);
          const maybeEnglish = /[A-Za-z]/.test(text) && !/[À-ÖØ-öø-ÿ]/.test(text);
          const meta = cards[i].querySelector('.meta');
          meta.textContent += ` | OCR: ${'${'}Math.round(confidence)}%`;
          if (!(maybeEnglish && confidence >= minConfidence)) {
            cards[i].style.opacity = .35;
          } else {
            passed++;
            const p = cards[i].querySelector('.image-info p');
            p.textContent = text.slice(0, 150) + (text.length>150?'…':'');
          }
        }catch {}
      }
      setProgress(100, 'Concluído');
      toast(`${'${'}passed} imagem(ns) com texto em inglês acima de ${'${'}minConfidence}%`);
    }

    document.querySelector('#searchBtn').addEventListener('click', async ()=>{
      const url = document.querySelector('#siteUrl').value.trim();
      const limit = Number(document.querySelector('#limit').value) || 40;
      const minConf = Number(document.querySelector('#minConfidence').value) || 60;
      const lang = (document.querySelector('#lang')?.value || 'eng').trim();

      if(!/^https?:\/\//.test(url)){ toast('Digite uma URL começando com http(s)://', false); return; }

      $('#resultsContainer').innerHTML = '';
      $('#status').innerHTML = '<div class="loading">Buscando imagens…</div>';
      setProgress(8, 'Coletando…');

      try{
        const data = await fetchImagesFromServer(url, limit);
        if(!data.ok || !data.images?.length){ $('#status').innerHTML = '<div class="loading">Sem imagens detectadas.</div>'; setProgress(100,''); return; }
        renderCards(data.images);
        await analyzeWithOCR(minConf, lang);
      }catch(e){
        $('#status').innerHTML = '<div class="loading">Erro: não consegui buscar imagens.</div>';
        setProgress(100,'');
        toast('Falha na coleta', false);
      }
    });

    document.querySelector('#siteUrl').addEventListener('keypress', e => {
      if (e.key === 'Enter') document.querySelector('#searchBtn').click();
    });
  </script>
</body>
</html>
