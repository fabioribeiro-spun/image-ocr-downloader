<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OCR (eng) • Ads Transparency</title>
<style>
  body{font:16px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;background:#0f172a;color:#e5e7eb;margin:0}
  .wrap{max-width:900px;margin:30px auto;padding:0 20px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:18px}
  .bar{position:relative;background:#0b1220;border:1px solid #1f2937;height:14px;border-radius:8px;overflow:hidden}
  .bar>i{position:absolute;top:0;left:0;height:100%;background:#10b981}
  button{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  input[type=number]{width:90px}
  code{background:#0b1220;border:1px solid #1f2937;padding:2px 6px;border-radius:6px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>OCR (English) & Zip</h2>
    <p>Esta aba recebe as URLs do coletor. Se nada chegar automaticamente, use os botões abaixo para colar do clipboard.</p>

    <div class="btns">
      <label>Min. confiança (%): <input id="conf" type="number" value="60" min="0" max="100"></label>
      <label>Máx. imagens: <input id="limit" type="number" value="100" min="1" max="400"></label>
      <button id="start">Iniciar</button>
      <button id="paste">Colar do clipboard</button>
      <button id="pasteStart">Colar & Iniciar</button>
    </div>

    <p><small>Critério “inglês”: contém letras A–Z e não contém acentos (ASCII).</small></p>
    <textarea id="box" style="width:100%;height:200px;margin-top:8px;border-radius:8px;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb"></textarea>

    <div style="margin-top:12px" class="bar"><i id="p" style="width:0%"></i></div>
    <div id="log" style="margin-top:8px;font-size:13px;color:#9ca3af"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.1/dist/tesseract.min.js"></script>
<script>
const BASE = location.origin;
const API_ZIP = BASE + "/api/download-zip";
const PROXY = u => BASE + "/api/proxy-image?url=" + encodeURIComponent(u);

let received = false;
// recebe do coletor (bookmarklet) via postMessage
window.addEventListener("message", (e)=>{
  if (e.origin !== BASE) return;
  if (e.data && e.data.type === "ads-urls" && Array.isArray(e.data.urls)) {
    received = true;
    document.getElementById("box").value = e.data.urls.join("\n");
  }
});
setTimeout(()=>{ if(!received){ console.log("Nenhuma lista recebida via postMessage; use Colar do clipboard."); }}, 2000);

async function pasteFromClipboard(){
  try{
    const txt = await navigator.clipboard.readText();
    if(txt) document.getElementById("box").value = txt.trim();
  }catch(err){
    alert("Não consegui ler o clipboard. Clique no textarea e use Ctrl/Cmd+V.");
  }
}
document.getElementById("paste").onclick = pasteFromClipboard;
document.getElementById("pasteStart").onclick = async ()=>{
  await pasteFromClipboard();
  document.getElementById("start").click();
};

document.getElementById("start").onclick = async ()=>{
  const raw = document.getElementById("box").value.trim().split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const limit = Math.min(Number(document.getElementById("limit").value)||100, raw.length);
  const minConf = Number(document.getElementById("conf").value) || 60;
  const urls = raw.slice(0, limit);
  if (!urls.length) { alert("Cole as URLs primeiro (1 por linha)"); return; }

  const prog = document.getElementById("p"), log = document.getElementById("log");
  const isAscii = t => /[A-Za-z]/.test(t) && !/[À-ÖØ-öø-ÿ]/.test(t);
  const approved = [];

  let done = 0;
  for (const u of urls) {
    prog.style.width = Math.round((++done/urls.length)*100) + "%";
    log.textContent = "OCR " + done + "/" + urls.length;
    try {
      const img = await loadImage(PROXY(u));
      const [cv] = drawScaled(img, 900);
      const r = await Tesseract.recognize(cv, "eng");
      const words = r.data.words || [];
      const conf = words.length ? words.reduce((s,w)=>s+(w.confidence||0),0)/words.length : (r.data.confidence||0);
      const text = (r.data.text||"").trim();
      if (isAscii(text) && conf >= minConf) approved.push(u);
      await sleep(40);
    } catch (e) {}
  }

  if (!approved.length) { alert("Nenhuma imagem aprovada com texto em inglês >= " + minConf + "%."); return; }
  if (!confirm(`Aprovadas ${approved.length} de ${urls.length}. Baixar ZIP?`)) return;

  try {
    const resp = await fetch(API_ZIP, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({urls: approved})});
    if (!resp.ok) throw new Error("Falha no servidor");
    const blob = await resp.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = "ads-english.zip"; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  } catch (e) {
    console.error(e); alert("Erro ao gerar ZIP.");
  }
};

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function loadImage(u){
  return new Promise((res,rej)=>{
    const im = new Image(); im.crossOrigin = "anonymous";
    im.onload = ()=>res(im); im.onerror = rej; im.src = u;
  });
}
function drawScaled(img, maxSide){
  const scale = Math.min(1, maxSide / Math.max(img.naturalWidth, img.naturalHeight));
  const w = Math.max(1, Math.round(img.naturalWidth * scale));
  const h = Math.max(1, Math.round(img.naturalHeight * scale));
  const cv = document.createElement("canvas"); cv.width = w; cv.height = h;
  const ctx = cv.getContext("2d"); ctx.drawImage(img, 0, 0, w, h);
  return [cv, ctx];
}
</script>
</body>
</html>
