(async () => {
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  // Rola para baixo para acionar lazy-loading
  for (let i = 0; i < 12; i++) {
    window.scrollBy(0, window.innerHeight * 1.25);
    await sleep(800);
  }

  // Utilitários
  const getBg = (el) => {
    try {
      const bg = getComputedStyle(el).backgroundImage || "";
      return [...bg.matchAll(/url\((?:'|")?(.*?)(?:'|")?\)/g)].map(m => m[1]);
    } catch { return []; }
  };

  const collectFromRoot = (root) => {
    const out = new Set();
    const pick = (u) => {
      if (u && /^https?:\/\//.test(u) && !/\.svg($|\?)/i.test(u) && !u.startsWith("data:")) out.add(u);
    };

    // <img> + srcset (pega a maior densidade quando houver)
    root.querySelectorAll("img").forEach(img => {
      let u = img.currentSrc || img.src;
      const ss = img.getAttribute("srcset");
      if (ss) {
        try {
          const parts = ss.split(",").map(x => x.trim().split(" "));
          parts.sort((a, b) => parseInt((b[1] || "0").replace(/\D/g, "")) - parseInt((a[1] || "0").replace(/\D/g, "")));
          if (parts[0] && parts[0][0]) u = parts[0][0];
        } catch {}
      }
      pick(u);
    });

    // background-image
    root.querySelectorAll("*").forEach(el => getBg(el).forEach(pick));

    // shadow DOM
    root.querySelectorAll("*").forEach(el => {
      if (el.shadowRoot) {
        for (const u of collectFromRoot(el.shadowRoot)) out.add(u);
      }
    });

    return out;
  };

  const urls = new Set();
  // Coleta no documento atual (você está dentro do frame correto)
  for (const u of collectFromRoot(document)) urls.add(u);

  const list = [...urls].slice(0, 200);
  if (!list.length) {
    alert("Não encontrei imagens neste frame. Tente selecionar outro frame no dropdown do Console e rodar de novo.");
    return;
  }

  // Copia para a área de transferência (função 'copy' existe no DevTools)
  try { copy(list.join("\n")); } catch {}
  alert(`Coletadas ${list.length} URLs. Vou abrir a página de OCR; cole as URLs lá, se não aparecerem automaticamente.`);

  // Abre sua página de OCR
  window.open("https://image-ocr-downloader.onrender.com/ocr.html", "_blank");
})();
